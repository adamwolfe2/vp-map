
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// User Model (Synced with Clerk)
model User {
  id              String   @id @default(cuid())
  clerkId         String   @unique
  email           String   @unique
  name            String?
  role            Role     @default(OPERATOR)
  
  // Credits System
  credits         Int      @default(0) // Available tokens for scraping
  
  // Relations
  transactions    CreditTransaction[]
  leads           Lead[]
  savedRoutes     SavedRoute[]
  products        Product[]
  machines        Machine[]
  restocks        RestockLog[]
  expenses        Expense[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Phase 7: Gamification
  points          Int      @default(0)
  isPublic        Boolean  @default(false) // Opt-in for leaderboard
}

enum Role {
  ADMIN
  OPERATOR
}

// Leads (Scraped Data)
model Lead {
  id              String   @id @default(cuid())
  ownerId         String
  owner           User     @relation(fields: [ownerId], references: [id])
  
  businessName    String
  address         String
  phone           String?
  source          String   @default("google_places") // e.g., "google_places", "manual"
  status          LeadStatus @default(NEW)
  
  latitude        Float?
  longitude       Float?

  // Phase 6: Lead Assignment
  assignedAt      DateTime?
  adminNotes      String?
  originalFinderId String? // Admin ID who found it
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

enum LeadStatus {
  NEW
  CONTACTED
  INTERESTED
  CONVERTED
  REJECTED
}

// Credit Transactions (Audit Log)
model CreditTransaction {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id])
  
  amount          Int      // Positive for purchase, negative for usage
  type            String   // "purchase", "scrape_usage", "admin_gift"
  description     String?
  
  createdAt       DateTime @default(now())
}

// Routes (Phase 1)
model SavedRoute {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id])
  name            String
  stops           Json     // Ordered list of stop objects
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// --- Phase 2: Inventory & Stocking ---

model Product {
  id              String   @id @default(cuid())
  userId          String?  // If null, it's a "Global" product (Coke, Pepsi)
  user            User?    @relation(fields: [userId], references: [id])
  
  name            String
  brand           String?
  upc             String?  @unique // Barcode
  cost            Float?   // COGS
  price           Float?   // Recommended Vend Price
  imageUrl        String?
  
  slots           Slot[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model Machine {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id])
  
  name            String   // e.g. "Gym Lobby Snack"
  type            String   // "Snake", "Drink", "Combo"
  locationId      String?  // Link to map location (optional for now)
  
  planogram       Planogram?
  restocks        RestockLog[]
  expenses        Expense[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model Planogram {
  id              String   @id @default(cuid())
  machineId       String   @unique
  machine         Machine  @relation(fields: [machineId], references: [id])
  
  slots           Slot[]
  
  updatedAt       DateTime @updatedAt
}

model Slot {
  id              String   @id @default(cuid())
  planogramId     String
  planogram       Planogram @relation(fields: [planogramId], references: [id])
  
  productId       String?
  product         Product?  @relation(fields: [productId], references: [id])
  
  position        String    // e.g. "A1", "B4"
  capacity        Int       @default(10)
  currentStock    Int       @default(0)
  price           Float     @default(1.50)
  
  updatedAt       DateTime @updatedAt

  @@unique([planogramId, position])
}

model RestockLog {
  id              String   @id @default(cuid())
  machineId       String
  machine         Machine  @relation(fields: [machineId], references: [id])
  
  userId          String
  user            User     @relation(fields: [userId], references: [id])
  
  notes           String?
  totalCost       Float?
  totalRevenue    Float?   // Cash collected
  
  createdAt       DateTime @default(now())
}

model Expense {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id])
  
  date            DateTime @default(now())
  category        String   // "Gas", "Insurance", "Repair", "COGS", "Other"
  amount          Float
  description     String?
  machineId       String?
  machine         Machine? @relation(fields: [machineId], references: [id])
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}
